<!doctype html>
<html>
<head>
  <meta name="google-site-verification" content="bHeMePUL_gILh9s3NFMaeYXRhd2-_POiFpUcFt1y4Pk" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=550, maximum-scale=1.0" />
  <meta name="keywords" content="mike mayo, mikemayo, ruby,tests,minitest,colors,instafail,progressbar,events" />
  <meta name="description" content="A simple event system for MiniTest to make reporting plugins easier to implement." />
  <title>
    MiniTest Events -  Mike Mayo
  </title>
  <link rel="stylesheet" href="/css/reset.css" type="text/css" />
  
  <link rel="stylesheet" href="/css/screen.css" type="text/css" />
  <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
  <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" />
  <link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="/css/ipad.css" type="text/css" />
  <link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/mikemayo" />
  <link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <link href="/images/icon.jpg" rel="apple-touch-icon" />
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20085238-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>
</head>
<body>
  <div id="wrapper">
    <div id="inner">
      <div id="container">
        <div id="header">
          <h1>
            
              <a href="/">&larr; Mike Mayo</a>
            
          </h1>
          <ul>
            <li>
              <a href="/projects">Projects</a>
            </li>
            <li>
              <a href="http://github.com/gotmayonase">Github &rarr;</a>
            </li>
            <li>
              <a href="http://twitter.com/mike_mayo">Twitter &rarr;</a>
            </li>
            <li>
              <a href="/contact">Contact</a>
            </li>
          </ul>
          <hr class="right"/>
        </div> <!-- end #header -->
        <h2>MiniTest Events</h2>
        

<p class="article_date date">
  05 Dec 2010
</p>

<hr/>

<div id="content">
	<p>A few weeks ago I made a hack to <a href="https://github.com/seattlerb/minitest">MiniTest</a> to add <a href="https://github.com/jeffkreeftmeijer/fuubar">Fuubar-like</a> functionality.  Unfortunately the hack was a little dirty, and I wanted to make MiniTest more extendable, at least for reporting purposes.  My solution was to borrow from the Events system I wrote for <a href="https://github.com/wiecklabs/harbor">Harbor</a> (a web framework we wrote and use at <a href="http://www.wieck.com">Wieck Media</a>).</p>
<p>The concept is very simple; you just raise an event wherever you feel you need to, and pass in a context object of some kind.  Then you register an event handler, which is just a class with a call method that is executed at the time of the event raise.</p>
<p>For example, here I am raising an event just before all of the tests begin to run:</p>
<div>
<pre>
<code class='ruby'>event = RunAnythingEvent.new(self, type, suites, options)

raise_event(:run_anything_start, event)</code>
</pre>
</div>
<p>As you can see it&#8217;s using a special RunAnythingEvent context object, whose definition looks like so:</p>
<div>
<pre>
<code class='ruby'>class RunAnythingEvent &amp;lt; BaseEvent

attr_reader :runner, :type, :output, :suites, :options
attr_accessor :test_count, :assertion_count, :report, :failures, :errors, :skips

def initialize(runner, type, suites, options)
super()
@runner = runner
@output = runner.output
@suites = suites
@type = type
@options = options
end

end</code>
</pre>
</div>
<p>And here is an example of an event handler for this event:</p>
<div>
<pre>
<code class='ruby'>class RunAnythingStartHandler

def initialize(event)
@event = event
@output = event.output
@type = event.type
end

def call
@output.puts
<code>output.puts &amp;quot;# Running #{</code>type}s:&quot;
@output.puts
end

end</code>
</pre>
</div>
<p>Which is registered by calling the following method off the class where the event was raised:</p>
<div>
<pre>
<code class='ruby'>register_event_handler(:run_anything_start, RunAnythingStartHandler)</code>
</pre>
</div>
<p>This particular example illustrates an important part of my goal.  I wanted to decouple the reporting of the tests from the actual tests themselves.  In order to further this I have created plugins that enable and disable the required event handlers which deal with outputting results in specific ways.  I have also moved all the base reporting into a plugin (<code>MiniTest::Reporting</code>) which is enabled by default.</p>
<p>The next step, which I&#8217;ve already partially completed, is to create plugins that handle alternative output options like the progress bar and instafailing.  If you&#8217;re interested, the work is being done in the <a href="https://github.com/gotmayonase/minitest/tree/events">events branch</a> on my Github account.  Assuming Node.js doesn&#8217;t monopolize all my time, I hope to have it completed in the near future.  If you have any ideas, feel free to let me know.</p>
</div>

<span class="article_buttons">
  <a class="tweet" target="_blank">
    <span class="balloon">tweet!</span> <img src="/images/twitter.png"/>
  </a>
  <a href="http://feeds.feedburner.com/mikemayo">
    <span class="balloon">subscribe!</span> <img src="/images/rss.png"/>
  </a>
  <a class="reddit" target="_blank">
    <span class="balloon">reddit!</span> <img src="/images/reddit.png"/>
  </a>
</span>

<hr/>

<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = 'http://mikemayoblog.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
      </div> <!-- end #container -->

      <div id="ads">
        <div class="ad" id="promotejs">
          <a href='https://developer.mozilla.org/en/JavaScript' title='Learn JS'>
            <img src='http://static.jsconf.us/promotejsv.gif' height='280' width='160' alt='JS Function .arguments'/>
          </a>
        </div>
      </div> <!-- end #ads -->
      
      <div id="footer">
        <p>
          Blog design by <a href="http://jeffkreeftmeijer.com/">Jeff Kreeftmeijer</a>
        </p>
      </div> <!-- end #footer -->
      
    </div> <!-- end #inner -->
  </div> <!-- end #wrapper -->

  <script src="/js/jquery.js" type="text/javascript"></script>
  <script src="/js/hummingbird.js" type="text/javascript"></script>
  <script type="text/javascript">
    $('.tweet').attr('href', 'http://twitter.com/share?url=' + escape(document.location) + '&via=mike_mayo&text=' + escape(document.title.split(' - ')[0]));
    $('.reddit').attr('href', 'http://reddit.com/submit?url=' + escape(document.location) + '&title=' + escape(document.title.split(' - ')[0]));
    HummingbirdTracker.track({
      site: 'mikemayo.org'
    });
  </script>
</body>
</html>
